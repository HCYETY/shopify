{% liquid
    assign url = shop.url
    assign page_type = request.page_type
%}

{%- if page_type == 'product' -%}
    {% liquid
      assign origin = request.origin
      assign fa_current_variant = product.selected_or_first_available_variant
      assign fa_variant_count   = product.variants | size
    %}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Product",
      "@id": "{{ canonical_url }}#product",
      "name": "{{ product.title | strip_html | escape }}",
      "url": "{{ origin }}{{ product.url }}",
      {% if product.variants.first.sku != blank %}
      "sku": "{{ product.variants.first.sku }}",
      {% else %}
      "sku": "{{ product.variants.first.id }}",
      {% endif %}
      {% if product.variants.first.barcode != blank and product.variants.first.barcode.size == 12 %}
      "gtin12": "{{ product.variants.first.barcode }}",
      {% endif %}
      {% if product.variants.first.barcode != blank and product.variants.first.barcode.size == 13 %}
      "gtin13": "{{ product.variants.first.barcode }}",
      {% endif %}
      {% if product.variants.first.barcode != blank and product.variants.first.barcode.size == 14 %}
      "gtin14": "{{ product.variants.first.barcode }}",
      {% endif %}
      "productID": "{{ product.id }}",
      "brand": { "@type": "Brand", "name": "{{ product.vendor | escape }}" },
      "description": "{{ product.description | strip_html | escape | strip_newlines }}",
      {% if product.featured_image %}
      "image": "https:{{ product.featured_image.src | img_url: 'original' }}",
      {% endif %}

      "offers": {% if fa_variant_count > 1 %}[{% endif %}
      {
        "@type": "Offer",
        "priceCurrency": "{{ shop.currency }}",
        "price": "{{ fa_current_variant.price | money_without_currency | strip_html | remove: ',' }}",
        "itemCondition": "https://schema.org/NewCondition",
        "availability": "https://schema.org/{% if fa_current_variant.available %}InStock{% else %}OutOfStock{% endif %}",
        "url": "{{ origin }}{{ fa_current_variant.url }}"
        {% if fa_current_variant.image %},
          {% assign variant_image_size = fa_current_variant.image.width | append: 'x' %}
          "image": "https:{{ fa_current_variant.image.src | img_url: variant_image_size }}"
        {% elsif product.featured_image %},
          "image": "https:{{ product.featured_image.src | img_url: 'original' }}"
        {% endif %}
        {% if fa_current_variant.title != 'Default Title' %},
          "name": "{{ product.title | strip_html | escape }} - {{ fa_current_variant.title | escape }}"
        {% else %},
          "name": "{{ product.title | strip_html | escape }}"
        {% endif %}
        {% if fa_current_variant.barcode != blank and fa_current_variant.barcode.size == 12 %} , "gtin12": "{{ fa_current_variant.barcode }}" {% endif %}
        {% if fa_current_variant.barcode != blank and fa_current_variant.barcode.size == 13 %} , "gtin13": "{{ fa_current_variant.barcode }}" {% endif %}
        {% if fa_current_variant.barcode != blank and fa_current_variant.barcode.size == 14 %} , "gtin14": "{{ fa_current_variant.barcode }}" {% endif %},
        "sku": "{{ fa_current_variant.sku | default: fa_current_variant.id }}",
        "priceValidUntil": "{{ 'now' | date: '%s' | plus: 31536000 | date: '%Y-%m-%d' }}"
      }{% if fa_variant_count > 1 %},{% endif %}
      {% for variant in product.variants %}
        {% if variant != product.selected_or_first_available_variant %}
        {
          "@type": "Offer",
          "priceCurrency": "{{ shop.currency }}",
          "price": "{{ variant.price | money_without_currency | strip_html | remove: ',' }}",
          "itemCondition": "https://schema.org/NewCondition",
          "availability": "https://schema.org/{% if variant.available %}InStock{% else %}OutOfStock{% endif %}",
          "url": "{{ origin }}{{ variant.url }}"
          {% if variant.image %},
            {% assign variant_image_size = variant.image.width | append: 'x' %}
            "image": "https:{{ variant.image.src | img_url: variant_image_size }}"
          {% elsif product.featured_image %},
            "image": "https:{{ product.featured_image.src | img_url: 'original' }}"
          {% endif %}
          {% if variant.title != 'Default Title' %},
            "name": "{{ product.title | strip_html | escape }} - {{ variant.title | escape }}"
          {% else %},
            "name": "{{ product.title | strip_html | escape }}"
          {% endif %}
          {% if variant.barcode != blank and variant.barcode.size == 12 %} , "gtin12": "{{ variant.barcode }}" {% endif %}
          {% if variant.barcode != blank and variant.barcode.size == 13 %} , "gtin13": "{{ variant.barcode }}" {% endif %}
          {% if variant.barcode != blank and variant.barcode.size == 14 %} , "gtin14": "{{ variant.barcode }}" {% endif %},
          "sku": "{{ variant.sku | default: variant.id }}",
          "priceValidUntil": "{{ 'now' | date: '%s' | plus: 31536000 | date: '%Y-%m-%d' }}"
        }{% unless forloop.last %},{% endunless %}
        {% endif %}
      {% endfor %}
      {% if fa_variant_count > 1 %}]{% endif %}

      {% if product.metafields.reviews.rating_count and product.metafields.reviews.rating_count > 0 %},
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "{{ product.metafields.reviews.rating.value }}",
        "ratingCount": "{{ product.metafields.reviews.rating_count }}",
        "bestRating": "{{ product.metafields.reviews.rating.value.scale_max }}",
        "worstRating": "{{ product.metafields.reviews.rating.value.scale_min }}"
      }
      {% endif %}
    }
    </script>

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Home",
          "item": "{{ origin }}"
        }
        {% if collection %},
        {
          "@type": "ListItem",
          "position": 2,
          "name": "{{ collection.title | strip_html | escape }}",
          "item": "{{ origin }}{{ collection.url }}"
        },
        {
          "@type": "ListItem",
          "position": 3,
          "name": "{{ product.title | strip_html | escape }}",
          "item": "{{ canonical_url }}"
        }
        {% else %},
        {
          "@type": "ListItem",
          "position": 2,
          "name": "{{ product.title | strip_html | escape }}",
          "item": "{{ canonical_url }}"
        }
        {% endif %}
      ]
    }
    </script>

{%- elsif page_type == 'article' -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Article",
  "@id": "{{ canonical_url }}#article",
  "mainEntityOfPage": { "@type": "WebPage", "@id": "{{ canonical_url }}" },
  "headline": "{{ article.title }}",
  "description": "{% if page_description != blank %}{{ page_description | strip_html }}{% else %}{{ article.excerpt_or_content | strip_html | truncate: 160 }}{% endif %}",
  "author": { "@type": "Person", "name": "{{ article.author }}" }
  {% if article.image %},
  "image": ["{{ article.image | img_url: '1024x1024' }}"]
  {% endif %},
  "datePublished": "{{ article.published_at | date: '%Y-%m-%d' }}",
  "dateModified": "{{ article.updated_at | date: '%Y-%m-%d' }}",
  "publisher": { "@type": "Organization", "name": "{{ shop.name | strip_html | escape }}" }
}
</script>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "{{ shop.url }}"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "{{ blog.title | strip_html | escape }}",
      "item": "{{ shop.url }}{{ blog.url }}"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": "{{ article.title | strip_html | escape }}",
      "item": "{{ canonical_url }}"
    }
  ]
}
</script>

{%- elsif page_type == 'collection' and collection.handle -%}
<!-- CollectionPage -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "@id": "{{ canonical_url }}#collection",
  "name": "{{ collection.title | strip_html | escape }}",
  "url": "{{ canonical_url }}"{% if collection.description != blank %},
  "description": "{{ collection.description | split: '[lang2]' | first | strip_html | escape }}"{% endif %}
}
</script>

<!-- BreadcrumbList: Home -> Collection -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "{{ url }}"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "{{ collection.title | strip_html | escape }}",
      "item": "{{ canonical_url }}"
    }
  ]
}
</script>

{%- endif -%}
